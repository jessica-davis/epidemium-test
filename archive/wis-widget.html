<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Weighted Interval Score (WIS)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #fff;
            color: #1C2442;
            padding: 20px;
        }
        .widget-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1C2442;
            margin-bottom: 8px;
        }
        .header p {
            font-size: 0.9rem;
            color: #2F4474;
        }

        .controls-section {
            background: #F8F9FC;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1C2442;
            margin-bottom: 10px;
            display: block;
        }

        .interval-toggles {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .interval-btn {
            padding: 8px 16px;
            border: 2px solid #344D84;
            background: white;
            color: #344D84;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter';
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .interval-btn.active {
            background: #344D84;
            color: white;
        }

        .interval-btn:hover {
            background: #1E9CC5;
            border-color: #1E9CC5;
            color: white;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1E9CC5;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #344D84;
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1E9CC5;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .slider::-moz-range-thumb:hover {
            background: #344D84;
            transform: scale(1.2);
        }

        .slider-value {
            min-width: 100px;
            padding: 6px 12px;
            background: white;
            border: 2px solid #5ACDC5;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            color: #1C2442;
        }

        #chart {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }

        .score-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .score-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #E5E7EB;
            transition: all 0.2s;
        }

        .score-card.highlight {
            border-color: #1E9CC5;
            box-shadow: 0 4px 12px rgba(30, 156, 197, 0.15);
        }

        .score-card.total {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #344D84 0%, #1E9CC5 100%);
            color: white;
            border: none;
        }

        .score-title {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.7;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .score-subtitle {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .components-breakdown {
            background: #DFF8ED;
            border: 2px solid #5ACDC5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .components-breakdown h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #344D84;
            margin-bottom: 12px;
        }

        .component-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(90, 205, 197, 0.3);
            font-size: 0.85rem;
        }

        .component-item:last-child {
            border-bottom: none;
        }

        .component-label {
            font-weight: 500;
            color: #1C2442;
        }

        .component-value {
            font-weight: 600;
            color: #344D84;
        }

        .component-penalty {
            color: #E63946;
        }

        .insight-box {
            background: #FFF4E6;
            border-left: 4px solid #FF9500;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .insight-box p {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #1C2442;
        }

        .insight-box strong {
            color: #FF9500;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }

        @media (max-width: 600px) {
            .score-panel {
                grid-template-columns: 1fr;
            }
            .score-card.total {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="header">
            <h2>Understanding Weighted Interval Score (WIS)</h2>
            <p>Explore how forecast quality is measured using prediction intervals</p>
        </div>

        <div class="controls-section">
            <div class="control-group">
                <label class="control-label">Select Prediction Intervals to Include</label>
                <div class="interval-toggles">
                    <button class="interval-btn active" data-interval="95">95% PI</button>
                    <button class="interval-btn active" data-interval="80">80% PI</button>
                    <button class="interval-btn active" data-interval="50">50% PI</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Adjust Observed Value</label>
                <div class="slider-container">
                    <input type="range" id="obs-slider" class="slider" min="5000" max="30000" value="14313" step="100">
                    <div class="slider-value" id="slider-value">14,313</div>
                </div>
            </div>
        </div>

        <div id="chart"></div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #FF6B6B; opacity: 0.3;"></div>
                <span>95% Prediction Interval</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4ECDC4; opacity: 0.4;"></div>
                <span>80% Prediction Interval</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #344D84; opacity: 0.5;"></div>
                <span>50% Prediction Interval</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #E63946; border-radius: 50%; width: 12px; height: 12px;"></div>
                <span>Observed Value</span>
            </div>
        </div>

        <div class="score-panel">
            <div class="score-card">
                <div class="score-title">Sharpness</div>
                <div class="score-value" id="sharpness-score">0</div>
                <div class="score-subtitle">Average interval width</div>
            </div>

            <div class="score-card">
                <div class="score-title">Penalties</div>
                <div class="score-value component-penalty" id="penalty-score">0</div>
                <div class="score-subtitle">Cost of missing observation</div>
            </div>

            <div class="score-card total">
                <div class="score-title">Total WIS</div>
                <div class="score-value" id="total-wis">0</div>
                <div class="score-subtitle">Lower is better</div>
            </div>
        </div>

        <div class="components-breakdown">
            <h4>Score Breakdown by Interval</h4>
            <div id="components-list"></div>
        </div>

        <div class="insight-box" id="insight-box">
            <p><strong>Insight:</strong> <span id="insight-text">Adjust the observed value or toggle intervals to see how WIS changes.</span></p>
        </div>
    </div>

    <script>
        // Forecast data (horizon 2: 2025-12-27)
        const FORECAST = {
            date: '2025-12-27',
            intervals: {
                50: { lower: 10025, upper: 17480, alpha: 0.50 },
                80: { lower: 7632, upper: 21425, alpha: 0.20 },
                95: { lower: 5371, upper: 26821, alpha: 0.05 }
            },
            median: 14313
        };

        let observedValue = 14313;
        let activeIntervals = [95, 80, 50];

        // Calculate WIS components for a single interval
        function calculateIntervalScore(lower, upper, alpha, observed) {
            const width = upper - lower;
            const sharpness = width * (alpha / 2);

            let penalty = 0;
            if (observed < lower) {
                penalty = (2 / alpha) * (lower - observed);
            } else if (observed > upper) {
                penalty = (2 / alpha) * (observed - upper);
            }

            return {
                width,
                sharpness,
                penalty,
                total: sharpness + penalty,
                covered: observed >= lower && observed <= upper
            };
        }

        // Calculate overall WIS
        function calculateWIS(observed, intervals) {
            const scores = intervals.map(level => {
                const interval = FORECAST.intervals[level];
                return calculateIntervalScore(
                    interval.lower,
                    interval.upper,
                    interval.alpha,
                    observed
                );
            });

            const totalScore = scores.reduce((sum, s) => sum + s.total, 0);
            const totalSharpness = scores.reduce((sum, s) => sum + s.sharpness, 0);
            const totalPenalty = scores.reduce((sum, s) => sum + s.penalty, 0);
            const K = intervals.length;

            return {
                wis: totalScore / K,
                sharpness: totalSharpness / K,
                penalty: totalPenalty / K,
                components: intervals.map((level, i) => ({
                    level,
                    ...scores[i],
                    ...FORECAST.intervals[level]
                }))
            };
        }

        // Draw the visualization
        function drawChart(observed, intervals) {
            d3.select('#chart').selectAll('*').remove();

            const margin = { top: 40, right: 30, bottom: 50, left: 30 };
            const container = document.getElementById('chart');
            const width = container.clientWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select('#chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const allValues = [
                ...intervals.map(i => FORECAST.intervals[i].lower),
                ...intervals.map(i => FORECAST.intervals[i].upper),
                observed
            ];

            const xScale = d3.scaleLinear()
                .domain([Math.min(...allValues) * 0.95, Math.max(...allValues) * 1.05])
                .range([0, width]);

            // Draw intervals
            const intervalData = intervals.map(level => ({
                level,
                ...FORECAST.intervals[level]
            })).sort((a, b) => b.level - a.level); // Draw 95% first (widest)

            const colors = {
                95: { fill: '#FF6B6B', opacity: 0.3 },
                80: { fill: '#4ECDC4', opacity: 0.4 },
                50: { fill: '#344D84', opacity: 0.5 }
            };

            intervalData.forEach((interval, i) => {
                const y = height / 2 - 40 + i * 30;
                const barHeight = 50;

                // Check if observation is covered
                const covered = observed >= interval.lower && observed <= interval.upper;

                // Draw interval bar
                svg.append('rect')
                    .attr('x', xScale(interval.lower))
                    .attr('y', y)
                    .attr('width', xScale(interval.upper) - xScale(interval.lower))
                    .attr('height', barHeight)
                    .attr('fill', colors[interval.level].fill)
                    .attr('opacity', colors[interval.level].opacity)
                    .attr('rx', 4);

                // Draw interval bounds
                svg.append('line')
                    .attr('x1', xScale(interval.lower))
                    .attr('x2', xScale(interval.lower))
                    .attr('y1', y - 5)
                    .attr('y2', y + barHeight + 5)
                    .attr('stroke', colors[interval.level].fill)
                    .attr('stroke-width', 2);

                svg.append('line')
                    .attr('x1', xScale(interval.upper))
                    .attr('x2', xScale(interval.upper))
                    .attr('y1', y - 5)
                    .attr('y2', y + barHeight + 5)
                    .attr('stroke', colors[interval.level].fill)
                    .attr('stroke-width', 2);

                // Label
                svg.append('text')
                    .attr('x', xScale(interval.lower) - 10)
                    .attr('y', y + barHeight / 2)
                    .attr('text-anchor', 'end')
                    .attr('dominant-baseline', 'middle')
                    .style('font-size', '0.85rem')
                    .style('font-weight', '600')
                    .style('fill', colors[interval.level].fill)
                    .text(`${interval.level}% PI`);

                // Coverage indicator
                if (covered) {
                    svg.append('text')
                        .attr('x', xScale(interval.upper) + 10)
                        .attr('y', y + barHeight / 2)
                        .attr('dominant-baseline', 'middle')
                        .style('font-size', '0.8rem')
                        .style('font-weight', '600')
                        .style('fill', '#16A34A')
                        .text('✓ Covered');
                } else {
                    svg.append('text')
                        .attr('x', xScale(interval.upper) + 10)
                        .attr('y', y + barHeight / 2)
                        .attr('dominant-baseline', 'middle')
                        .style('font-size', '0.8rem')
                        .style('font-weight', '600')
                        .style('fill', '#DC2626')
                        .text('✗ Missed');
                }
            });

            // Draw median line
            svg.append('line')
                .attr('x1', xScale(FORECAST.median))
                .attr('x2', xScale(FORECAST.median))
                .attr('y1', 0)
                .attr('y2', height)
                .attr('stroke', '#1E9CC5')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5,5')
                .attr('opacity', 0.5);

            svg.append('text')
                .attr('x', xScale(FORECAST.median))
                .attr('y', -5)
                .attr('text-anchor', 'middle')
                .style('font-size', '0.75rem')
                .style('font-weight', '600')
                .style('fill', '#1E9CC5')
                .text('Median');

            // Draw observed value
            const obsColor = '#E63946';
            svg.append('line')
                .attr('x1', xScale(observed))
                .attr('x2', xScale(observed))
                .attr('y1', 0)
                .attr('y2', height)
                .attr('stroke', obsColor)
                .attr('stroke-width', 3);

            svg.append('circle')
                .attr('cx', xScale(observed))
                .attr('cy', height / 2)
                .attr('r', 8)
                .attr('fill', obsColor);

            svg.append('text')
                .attr('x', xScale(observed))
                .attr('y', height + 20)
                .attr('text-anchor', 'middle')
                .style('font-size', '0.9rem')
                .style('font-weight', '700')
                .style('fill', obsColor)
                .text(`Observed: ${observed.toLocaleString()}`);

            // Draw x-axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).ticks(5).tickFormat(d => d.toLocaleString()))
                .style('font-size', '0.75rem');
        }

        // Update all displays
        function updateDisplay() {
            const result = calculateWIS(observedValue, activeIntervals);

            // Update score cards
            document.getElementById('sharpness-score').textContent = result.sharpness.toFixed(0);
            document.getElementById('penalty-score').textContent = result.penalty.toFixed(0);
            document.getElementById('total-wis').textContent = result.wis.toFixed(0);

            // Update components breakdown
            const componentsList = document.getElementById('components-list');
            componentsList.innerHTML = result.components.map(c => `
                <div class="component-item">
                    <span class="component-label">${c.level}% PI: [${c.lower.toLocaleString()}, ${c.upper.toLocaleString()}]</span>
                    <span class="component-value ${c.penalty > 0 ? 'component-penalty' : ''}">
                        ${c.total.toFixed(0)} ${c.covered ? '✓' : '✗'}
                    </span>
                </div>
            `).join('');

            // Update insight
            const insight = generateInsight(result);
            document.getElementById('insight-text').textContent = insight;

            // Draw chart
            drawChart(observedValue, activeIntervals);
        }

        // Generate contextual insight
        function generateInsight(result) {
            const allCovered = result.components.every(c => c.covered);
            const noneCovered = result.components.every(c => !c.covered);
            const hasNarrowIntervals = activeIntervals.includes(50);
            const hasWideIntervals = activeIntervals.includes(95);

            if (allCovered && result.penalty === 0) {
                return "Perfect! The observation falls within all selected intervals, so there's no penalty—only sharpness costs.";
            } else if (noneCovered && result.penalty > 0) {
                return "High penalty! The observation is outside all intervals. This significantly increases the WIS.";
            } else if (result.penalty > result.sharpness) {
                return "Penalties dominate the score. Missing the observation is more costly than the interval widths.";
            } else if (result.penalty === 0 && hasNarrowIntervals) {
                return "Well-calibrated forecast! Narrow intervals captured the observation, resulting in good sharpness and no penalty.";
            } else if (activeIntervals.length === 1) {
                return `Using only ${activeIntervals[0]}% PI. Try adding more intervals to see how WIS averages across multiple levels.`;
            } else if (activeIntervals.length === 3) {
                return "Evaluating with all intervals (50%, 80%, 95%) provides a comprehensive assessment of forecast quality.";
            } else {
                return "Adjust the observed value or toggle intervals to see how WIS changes.";
            }
        }

        // Event listeners
        document.querySelectorAll('.interval-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const interval = parseInt(btn.dataset.interval);

                if (btn.classList.contains('active')) {
                    if (activeIntervals.length > 1) {
                        btn.classList.remove('active');
                        activeIntervals = activeIntervals.filter(i => i !== interval);
                        updateDisplay();
                    }
                } else {
                    btn.classList.add('active');
                    activeIntervals.push(interval);
                    activeIntervals.sort((a, b) => b - a);
                    updateDisplay();
                }
            });
        });

        const slider = document.getElementById('obs-slider');
        const sliderValue = document.getElementById('slider-value');

        slider.addEventListener('input', (e) => {
            observedValue = parseInt(e.target.value);
            sliderValue.textContent = observedValue.toLocaleString();
            updateDisplay();
        });

        // Initialize
        updateDisplay();
    </script>
</body>
</html>
